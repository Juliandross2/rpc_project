# Makefile para el cliente cocinero

# Compilador
CC = gcc

# Opciones de compilación
CFLAGS = -Wall
INCLUDES = -I/usr/include/tirpc -I.

# Bibliotecas necesarias
LIBS = -ltirpc

# Nombre del ejecutable
TARGET = cocinero

# Archivo de interfaz RPC
RPC_INTERFACE = InterfaceCocineroServidorPedidos.x

# Archivos generados por rpcgen
RPCGEN_FILES = $(RPC_INTERFACE:.x=.h) \
               $(RPC_INTERFACE:.x=_clnt.c) \
               $(RPC_INTERFACE:.x=_xdr.c)

# Archivos fuente
SOURCES = cocinero.c

# Archivos objeto
OBJECTS = cocinero.o \
          InterfaceCocineroServidorPedidos_clnt.o \
          InterfaceCocineroServidorPedidos_xdr.o

# Regla principal
all: $(TARGET)

# Regla para generar archivos RPC
$(RPCGEN_FILES): $(RPC_INTERFACE)
	rpcgen -C -c $(RPC_INTERFACE) -o $(RPC_INTERFACE:.x=_xdr.c)
	rpcgen -C -h $(RPC_INTERFACE) -o $(RPC_INTERFACE:.x=.h)
	rpcgen -C -l $(RPC_INTERFACE) -o $(RPC_INTERFACE:.x=_clnt.c)
	@echo "Archivos RPC generados: $(RPCGEN_FILES)"
	@# Corregir includes
	perl -pi -e 's/<rpc\/rpc.h>/<tirpc\/rpc\/rpc.h>/' $(RPC_INTERFACE:.x=.h)
	@# Agregar constantes solo si no existen
	if ! grep -q "COCINEROPEDIDOS_PROG" $(RPC_INTERFACE:.x=.h); then \
		echo "#define COCINEROPEDIDOS_PROG ((u_long)0x20000003)" >> $(RPC_INTERFACE:.x=.h); \
	fi
	if ! grep -q "COCINEROPEDIDOS_VERS" $(RPC_INTERFACE:.x=.h); then \
		echo "#define COCINEROPEDIDOS_VERS ((u_long)1)" >> $(RPC_INTERFACE:.x=.h); \
	fi

# Reglas específicas para los objetos generados
InterfaceCocineroServidorPedidos_clnt.o: InterfaceCocineroServidorPedidos_clnt.c InterfaceCocineroServidorPedidos.h
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

InterfaceCocineroServidorPedidos_xdr.o: InterfaceCocineroServidorPedidos_xdr.c InterfaceCocineroServidorPedidos.h
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

cocinero.o: cocinero.c InterfaceCocineroServidorPedidos.h
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# Compilar el ejecutable
$(TARGET): $(OBJECTS)
	$(CC) $(CFLAGS) $(INCLUDES) -o $@ $^ $(LIBS)
	@echo "Ejecutable $(TARGET) creado"

# Limpieza completa
clean:
	rm -f $(TARGET) $(OBJECTS) $(RPCGEN_FILES)
	@echo "Todos los archivos generados eliminados"

.PHONY: all clean